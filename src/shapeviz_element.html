<link rel="import" href="../third_party/polymer/polymer-element.html">
<link rel="import" href="./model.html">
<link rel="import" href="./utils.html">
<link rel="import" href="./shapeviewer_element.html">
<dom-module id="shapeviz-element">

  <template>
    <style>
      * {
        user-select: none;
      }
      :host {
        display: flex;
        flex-direction: column;
      }
      #header {
        flex: 0 0 auto;
        display: block;
        backgorund-color: rgb(175,175,175);
        border-bottom: rgb(64,64,64);
      }
      hbox {
        flex: 1 1 auto;
        display: flex;
        flex-direction: row;
        max-height: 800px;
      }
      vbox {
        display: flex;
        flex-direction: column;
        max-width: 400px;
      }
      lbox {
        display: flex;
        flex-direction: column;
        min-width: 300px;
        max-width: 400px;
      }
      rbox {
        display: flex;
        flex-direction: column;
        min-width: 300px;
        max-width: 400px;
      }
      hbar {
        display: block;
        background-color: rgb(175,175,175);
        height: 8px;
        border-top: rgb(230,230,230);
        border-bottom: rgb(64, 64, 64);
      }
      vbar {
        display: block;
        background-color: rgb(175,175,175);
        width: 8px;       
        border-left: rgb(230,230,230);
        border-right: rgb(64, 64, 64);
      }
      #shapeList {
        flex: 1 1 300px;
        display: block;
        overflow-y: auto;
      }
      #shapeList > div {
        display: flex;
      }
      #layerList {
        flex: 1 1 150px;
        display: block;
        overflow-y: auto;
      }
      hbox > vbox {
        flex: 1 1 auto;
      }
      #shapeViewer {
        flex: 1 1 auto;
      }
      #selectedShapeInfo {
        flex: 1 1 300px;
        display: block;
        overflow-y: auto;
        user-select: auto;
      }
      #selectedShapeInfo > div {
        display: flex;
      }
      #selectedLayerInfo {
        flex: 1 1 150px;
        display: block;
        overflow-y: auto;
        user-select: auto;
      }
      #selectedLayerInfo > div {
        display: flex;
      }
      .item-selected {
        background-color: rgb(185, 214, 251);
      }
    </style>
    <div id="header"></div>
    <hbox>
      <vbar></vbar>
      <lbox>
        <hbar></hbar>
        <div id="shapeList">
        </div>      
        <hbar></hbar>
        <div id="layerList">
        </div>        
        <hbar></hbar>
      </lbox>
      <vbar></vbar>     
      <rbox>
        <hbar></hbar>
        <div id="selectedShapeInfo">
        current selection
        </div>
        <hbar></hbar>        
        <div id="selectedLayerInfo">
        current selection
        </div>
        <hbar></hbar>
      </rbox>
      <vbar></vbar>
      <vbox>
        <hbar></hbar>
        <shapeviewer-element id="shapeViewer">
        </shapeviewer-element>
        <hbar></hbar>
      </vbox>
      <vbar></vbar>
    </hbox>
  </template>

  <script>
    class ShapeVizElement extends Polymer.Element {
      static get is() { return "shapeviz-element"; }

      constructor() {
        super();
        this.model = undefined;
        this.selectedShape_ = undefined;
        this.selectedLayer_ = undefined;
      }

      get title() {
        return this.$.header.textContent;
      }

      set title(title) {
        this.$.header.textContent = title;
      }

      loadCSV(data) {
        let model = new Model();
        model.loadCSV(data);
        this.model = model;

        this.selectedShape = undefined;
        this.selectedLayer = undefined;
        this.rebuildShapeList_();
        this.selectedShape = this.model.shapes[0];
      }

      rebuildShapeList_() {
        let sl = this.$.shapeList;
        this.$.shapeList.textContent = '';
        let shapes = this.model.shapes;
        shapes.sort(function(s1, s2) {
          return s2.frequency - s1.frequency;
        });

        function addItem(v1, v2) {
          var ve = document.createElement('span');
          ve.style.width = '100px';
          ve.textContent = v2;
          v1.appendChild(ve);
        }

        let row = document.createElement('div');
        addItem(row, '');
        addItem(row, 'frequency');
        addItem(row, 'layerCount');
        sl.appendChild(row);
        
        shapes.forEach(function(shape, shapeIdx) {
          let shapeDiv = document.createElement('div');
          shapeDiv.shape = shape;
          shapeDiv.textContent = '';
          addItem(shapeDiv, 'Shape ' + shapeIdx);
          addItem(shapeDiv, shape.frequency);
          addItem(shapeDiv, shape.layerCount)
          shapeDiv.addEventListener('click', function() {
            this.selectedShape = shape;
          }.bind(this));
          this.$.shapeList.appendChild(shapeDiv);
        }, this);

        var activeDiv = utils.findElementWithFieldMatching(this.$.shapeList, 'shape', this.selectedShape_);
        if (activeDiv)
          activeDiv.classList.add('item-selected');
      }

      get selectedShape() {
        return this.selectedShape_;
      }
      set selectedShape(selectedShape) {
        if (this.selectedShape_ === selectedShape)
          return;
        var activeDiv = utils.findElementWithFieldMatching(this.$.shapeList, 'shape', this.selectedShape_);
        if (activeDiv)
          activeDiv.classList.remove('item-selected');

        this.selectedShape_ = selectedShape;
        var activeDiv = utils.findElementWithFieldMatching(this.$.shapeList, 'shape', this.selectedShape_);
        if (activeDiv)
          activeDiv.classList.add('item-selected');

        this.updateSelectedShapeInfo_();
        this.rebuildLayerList_();
        this.$.shapeViewer.shape = this.selectedShape_;

        if (this.selectedShape_)
          this.selectedLayer = this.selectedShape_.layers[0];
        else
          this.selectedLayer = undefined;
      }

      updateSelectedShapeInfo_() {
        let ssi = this.$.selectedShapeInfo;
        ssi.textContent = '';
        if (this.selectedShape_ === undefined)
          return;

        function addRow(v1, v2) {
          var row = document.createElement('div');

          var v1e = document.createElement('span');
          v1e.style.width = '200px';
          v1e.textContent = v1;
          row.appendChild(v1e);

          var v2e = document.createElement('span');
          v2e.style.width = '500px';
          v2e.textContent = v2;
          row.appendChild(v2e);

          ssi.appendChild(row);
        }

        for (var k in this.selectedShape_.otherAttrs) {
          addRow(k, this.selectedShape_.otherAttrs[k]);
        }
      }

      updateShapeViewer_() {
      }

      rebuildLayerList_() {
        this.$.layerList.textContent = '';
        if(this.selectedShape_ === undefined)
          return;
        this.selectedShape_.layers.forEach(function(layer, layerIdx) {
          let layerDiv = document.createElement('div');
          layerDiv.layer = layer;
          layerDiv.textContent = 'Layer ' + layerIdx;
          layerDiv.addEventListener('click', function() {
            this.selectedLayer = layer;
          }.bind(this));
          this.$.layerList.appendChild(layerDiv);
        }, this);
        var activeDiv = utils.findElementWithFieldMatching(this.$.layerList, 'layer', this.selectedLayer_);
        if (activeDiv)
          activeDiv.classList.add('item-selected');
      }

      get selectedLayer() {
        return this.selectedLayer_;
      }
      set selectedLayer(selectedLayer) {
        if (this.selectedLayer_ === selectedLayer)
          return;
        var activeDiv = utils.findElementWithFieldMatching(this.$.layerList, 'layer', this.selectedLayer_);
        if (activeDiv)
          activeDiv.classList.remove('item-selected');

        this.selectedLayer_ = selectedLayer;
        this.updateSelectedLayerInfo_();
        this.$.shapeViewer.selectedLayer = this.selectedLayer_;

        var activeDiv = utils.findElementWithFieldMatching(this.$.layerList, 'layer', this.selectedLayer_);
        if (activeDiv)
          activeDiv.classList.add('item-selected');
      }

      updateSelectedLayerInfo_() {
        let sli = this.$.selectedLayerInfo;
        sli.textContent = '';
        if (this.selectedLayer_ === undefined)
          return;

        function addRow(v1, v2) {
          var row = document.createElement('div');

          var v1e = document.createElement('span');
          v1e.style.width = '200px';
          v1e.textContent = v1;
          row.appendChild(v1e);

          var v2e = document.createElement('span');
          v2e.style.width = '500px';
          v2e.textContent = v2;
          row.appendChild(v2e);

          sli.appendChild(row);
        }

        for (var k in this.selectedLayer_.otherAttrs) {
          addRow(k, this.selectedLayer_.otherAttrs[k]);
        }
      }
    }
    customElements.define(ShapeVizElement.is, ShapeVizElement);
  </script>

</dom-module>

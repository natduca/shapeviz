<script>
class Layer {
  constructor() {
    this.dstX = 0;
    this.dstY = 0;
    this.dstWidth = 0;
    this.dstHeight = 0;
    this.otherAttrs = {};
  }

  ratioToFloat(s) {
    let m = /(\d+)\/(\d+)/.exec(s);
    if (m) {
      return parseInt(m[1]) / parseInt(m[2]);
    }
    let v = parseInt(s);
    if (isNaN(v))
      throw new Error('omg no: ' + s);
    return v;
  }

  initFromRecords(records) {
    var nameToOffset = {
      layerType: 0,
      compositionType: 1,
      isProtected: 2,
      transform: 3,
      pixelFormat: 4,
      dataSpace: 5,
      dstX: 6,
      dstY: 7,
      dstWidth: 8,
      dstHeight: 9,
      scaleW: 10,
      scaleH: 11,
      alpha: 12
    }
    function getField(name){
      return records[nameToOffset[name]];
    }
    function getFieldName(idx){
      for (let k in nameToOffset) {
        if (nameToOffset[k] === idx)
          return k;
      }
      return undefined;
    }

    this.dstX = this.ratioToFloat(getField('dstX'));
    this.dstY = this.ratioToFloat(getField('dstY'));
    this.dstWidth = this.ratioToFloat(getField('dstWidth'));
    this.dstHeight = this.ratioToFloat(getField('dstHeight'));
    for (let i = 0; i < records.length; i++) {
      let fn = getFieldName(i);
      if (fn === undefined) {
        console.log("unknown field");
        continue;
      }
      this.otherAttrs[fn] = records[i];
    }
  }
}
class Shape {
  constructor() {
    this.numRecords = 5; // Number of attrs for Shape
    this.frequency = 0;
    this.layerCount = 0;
    this.otherAttrs = {};
    this.layers = [];
  }
  initFromRecords(records) {
    var nameToOffset = {
      frequency: 0,
      layerCount: 1,
      colorMode: 2,
      colorTransform: 3,
      screenRotation: 4,
    }
    function getField(name){
      return records[nameToOffset[name]];
    }
    function getFieldName(idx){
      for (let k in nameToOffset) {
        if (nameToOffset[k] === idx)
          return k;
      }
      return undefined;
    }

    this.frequency = parseInt(getField('frequency'));
    this.layerCount = parseInt(getField('layerCount'));
    for (let i = 2; i < records.length; i++) {
      let fn = getFieldName(i);
      if (fn === undefined) {
        console.log("unknown field");
        continue;
      }
      this.otherAttrs[fn] = records[i];
    }
  }
}

class Model {
  constructor() {
    this.shapes = [];
  }
  loadCSV(data) {
    let lines = data.split('\n');
    lines.forEach(function(line) {
      line = line.trim();
      if (line.length === 0)
        return;
      let records = line.split(',');
      if (isNaN(parseInt(records[0])))
        return;

      let shape = new Shape();
      let shapeRecords = records.slice(0, shape.numRecords);
      shape.initFromRecords(shapeRecords);
      var numPropsInLayer = (records.length - shape.numRecords) / shape.layerCount;
      for (let i = 0; i < shape.layerCount; i++) {
        let baseIndex = (i * numPropsInLayer) + shape.numRecords;
        let layerRecords = records.slice(baseIndex,
                                         baseIndex + numPropsInLayer);
        let layer = new Layer();
        layer.initFromRecords(layerRecords);
        shape.layers.push(layer);
      }
      this.shapes.push(shape);
    }, this);
  }
}
</script>